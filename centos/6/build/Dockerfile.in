@CENTOS_6_DOCKER_INCLUDE@

# install dev tools
RUN yum install -y rpm-build gcc tar git autoconf automake libtool

# setup rpmbuild environment
WORKDIR /opt/rpmbuild
ENV HOME /opt/rpmbuild
RUN mkdir -p $HOME/rpm/{BUILD,SRPMS,SPECS,SOURCES,RPMS}
RUN echo "%_topdir $HOME/rpm" > ~/.rpmmacros

# mod_auth_openidc depends
RUN yum install --enablerepo=centosplus -y openssl-devel 
RUN yum install --enablerepo=epel -y jansson-devel
RUN yum install -y httpd httpd-devel curl-devel hiredis-devel pcre-devel

ENV MOD_AUTH_OPENIDC_VERSION @MOD_AUTH_OPENIDC_VERSION@
ENV CJOSE_VERSION @CJOSE_VERSION@

ENV CJOSE_TGZ cjose-${CJOSE_VERSION}.tar.gz
ENV MOD_AUTH_OPENIDC_TGZ mod_auth_openidc-${MOD_AUTH_OPENIDC_VERSION}.tar.gz
ENV MOD_AUTH_OPENIDC_ORIG_TGZ libapache2-mod-auth-openidc_${MOD_AUTH_OPENIDC_VERSION}.orig.tar.gz

# build cjose RPM
RUN curl -o ${HOME}/rpm/SOURCES/${CJOSE_TGZ} https://mod-auth-openidc.org/download/${CJOSE_TGZ}
ADD cjose.spec ${HOME}/rpm/SPECS/cjose.spec
RUN rpmbuild --define "release ${CJOSE_VERSION}" -bb ${HOME}/rpm/SPECS/cjose.spec

#install cjose RPM
ENV CJOSE_PKG cjose-${CJOSE_VERSION}-1.el6.x86_64.rpm
RUN yum localinstall -y /opt/rpmbuild/rpm/RPMS/x86_64/${CJOSE_PKG}

# build mod_auth_openidc RPM
RUN curl -o ${HOME}/rpm/SOURCES/${MOD_AUTH_OPENIDC_TGZ} https://mod-auth-openidc.org/download/${MOD_AUTH_OPENIDC_ORIG_TGZ}
ADD mod_auth_openidc.spec ${HOME}/rpm/SPECS/mod_auth_openidc.spec
ENV HIREDIS_LIBS -lhiredis
RUN rpmbuild --define "release ${MOD_AUTH_OPENIDC_VERSION}" -bb ${HOME}/rpm/SPECS/mod_auth_openidc.spec
